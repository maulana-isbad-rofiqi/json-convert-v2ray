<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2Ray URI Super Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for modern icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ff 100%); /* Soft Gradient Background */
        }
        .container-card {
            max-width: 950px;
            margin: 2.5rem auto;
            padding: 2.5rem;
            background: #ffffff;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); /* Deeper Shadow */
            border: 1px solid #c3dafe;
        }
        textarea {
            resize: none;
            min-height: 200px;
        }
        .output-container {
            min-height: 350px; 
            background-color: #fcfdff;
            padding: 1rem;
            border: 1px solid #d1e5ff;
            border-radius: 1rem;
            overflow-y: auto;
        }
        /* Custom scrollbar style for output box */
        .output-container::-webkit-scrollbar {
            width: 8px;
        }
        .output-container::-webkit-scrollbar-thumb {
            background: #93c5fd;
            border-radius: 4px;
        }
        .output-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .glow-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .glow-button:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

    <div class="container-card rounded-3xl">
        <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2 text-center flex items-center justify-center">
            <i class="fas fa-rocket mr-4"></i> V2Ray Super Generator
        </h1>
        <p class="text-center text-gray-700 mb-8 font-semibold">Ubah konfigurasi JSON Anda menjadi URI VLESS/Trojan yang indah dan terperinci.</p>

        <!-- Input Area -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-3">
                <label for="jsonInput" class="block text-xl font-extrabold text-gray-800">
                    <i class="fas fa-file-code mr-2 text-purple-500"></i> Masukkan JSON Konfigurasi
                </label>
                <button id="openBotSettingsBtn" onclick="openBotSettingsModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-2 px-4 rounded-full transition duration-150 shadow-md transform hover:scale-105">
                    <i class="fas fa-robot mr-1"></i> Set Bot
                </button>
            </div>
            <textarea id="jsonInput" rows="10" 
                class="w-full p-5 border-2 border-purple-300 rounded-2xl focus:ring-purple-500 focus:border-purple-500 text-base shadow-xl transition duration-300"
                placeholder="Paste V2Ray configuration array here, e.g., [...]"></textarea>
            <p class="text-sm text-gray-500 mt-2">Pastikan input adalah array JSON V2Ray yang valid (`[...]`)</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-10">
            <button onclick="convertJsonToV2ray()"
                class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-black py-4 px-6 rounded-2xl transition duration-300 ease-in-out glow-button text-lg">
                <i class="fas fa-magic mr-2"></i> KONVERSI SEKARANG
            </button>
        </div>
        
        <!-- Message Box -->
        <div id="messageBox" class="hidden p-4 rounded-xl text-sm mb-6 font-medium border border-gray-300" role="alert"></div>

        <!-- Combined Output Area -->
        <div class="flex flex-col gap-6">
            <div class="flex-1">
                <label class="block text-xl font-extrabold text-gray-800 mb-3 border-l-4 border-blue-500 pl-3">
                    <i class="fas fa-list-alt mr-2 text-blue-500"></i> Hasil Konversi URI
                </label>
                <div id="allOutputContainer" class="output-container rounded-2xl">
                    <!-- Dynamic VLESS and Trojan cards will be inserted here -->
                    <p class="text-center text-gray-500 p-8">Tekan tombol 'Konversi Sekarang' untuk melihat hasil.</p>
                </div>
                <div class="mt-5">
                    <button onclick="copyAllUris('all')"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-2xl transition duration-150 shadow-lg text-lg">
                        <i class="fas fa-copy mr-2"></i> Salin SEMUA URI
                    </button>
                </div>
                <!-- Hidden textarea to hold raw URIs for "Copy All" functionality -->
                <textarea id="allRawUris" class="hidden"></textarea>
                <!-- Hidden textarea for Telegram formatted output -->
                <textarea id="telegramOutput" class="hidden"></textarea>
            </div>
        </div>
    </div>

    <!-- Bot Settings Modal -->
    <div id="botSettingsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl transform transition-all duration-300">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-robot mr-3 text-indigo-600"></i> Pengaturan Bot Telegram
                </h2>
                
                <p class="text-sm text-gray-600 mb-6">Masukkan Token Bot dan Chat ID Anda. Output konversi akan otomatis dikirim ke sini.</p>

                <div class="mb-4">
                    <label for="botTokenInput" class="block text-sm font-medium text-gray-700 mb-1">Token Bot</label>
                    <input type="password" id="botTokenInput" placeholder="Contoh: 1234567890:ABC-DEF..."
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>

                <div class="mb-6">
                    <label for="chatIdInput" class="block text-sm font-medium text-gray-700 mb-1">Chat ID</label>
                    <input type="text" id="chatIdInput" placeholder="Contoh: 123456789 atau @username"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
                
                <div id="botStatus" class="text-xs font-medium text-center p-2 rounded-lg hidden"></div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeBotSettingsModal()"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Batal
                    </button>
                    <button onclick="saveBotSettings()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        <i class="fas fa-save mr-1"></i> Simpan Pengaturan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY_TOKEN = 'telegramBotToken';
        const STORAGE_KEY_CHAT_ID = 'telegramChatId';

        // --- Bot Settings Modal Logic ---

        function openBotSettingsModal() {
            const modal = document.getElementById('botSettingsModal');
            const tokenInput = document.getElementById('botTokenInput');
            const chatIdInput = document.getElementById('chatIdInput');
            const botStatus = document.getElementById('botStatus');

            // Load saved values
            tokenInput.value = localStorage.getItem(STORAGE_KEY_TOKEN) || '';
            chatIdInput.value = localStorage.getItem(STORAGE_KEY_CHAT_ID) || '';
            botStatus.classList.add('hidden');
            
            modal.classList.remove('hidden');
        }

        function closeBotSettingsModal() {
            document.getElementById('botSettingsModal').classList.add('hidden');
        }

        function saveBotSettings() {
            const token = document.getElementById('botTokenInput').value.trim();
            const chatId = document.getElementById('chatIdInput').value.trim();
            const botStatus = document.getElementById('botStatus');

            if (token && chatId) {
                localStorage.setItem(STORAGE_KEY_TOKEN, token);
                localStorage.setItem(STORAGE_KEY_CHAT_ID, chatId);
                
                botStatus.textContent = "Pengaturan bot berhasil disimpan! Output akan dikirim otomatis.";
                botStatus.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
                botStatus.classList.add('bg-green-100', 'text-green-800');
                setTimeout(closeBotSettingsModal, 1500);

            } else if (token || chatId) {
                // Allows clearing one field by leaving it empty
                localStorage.setItem(STORAGE_KEY_TOKEN, token);
                localStorage.setItem(STORAGE_KEY_CHAT_ID, chatId);

                botStatus.textContent = "Hanya satu kolom yang diisi. Harap isi keduanya atau biarkan kosong untuk menonaktifkan.";
                botStatus.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                botStatus.classList.add('bg-yellow-100', 'text-yellow-800');
            } else {
                // Clear all settings
                localStorage.removeItem(STORAGE_KEY_TOKEN);
                localStorage.removeItem(STORAGE_KEY_CHAT_ID);

                botStatus.textContent = "Pengaturan bot dinonaktifkan.";
                botStatus.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
                botStatus.classList.add('bg-red-100', 'text-red-800');
                setTimeout(closeBotSettingsModal, 1500);
            }
        }

        async function sendToTelegram(text) {
            const token = localStorage.getItem(STORAGE_KEY_TOKEN);
            const chatId = localStorage.getItem(STORAGE_KEY_CHAT_ID);

            if (!token || !chatId || !text.trim()) {
                // Not configured or empty content
                return;
            }

            const telegramApiUrl = `https://api.telegram.org/bot${token}/sendMessage`;
            const payload = {
                chat_id: chatId,
                text: text,
                parse_mode: 'MarkdownV2',
                disable_web_page_preview: true
            };

            const MAX_RETRIES = 5;
            let delay = 1000; 

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(telegramApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        showMessage("Konversi berhasil dan output berhasil dikirim ke Telegram!", 'success');
                        return; // Success, exit loop
                    }

                    // Handle specific error responses if needed (e.g., rate limiting)
                    const errorData = await response.json();
                    if (response.status === 429) { // Too Many Requests (Rate Limiting)
                        console.warn(`Telegram API Rate Limit encountered. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        console.error("Telegram API Error:", errorData);
                        showMessage(`Konversi berhasil, tetapi gagal mengirim ke Telegram: ${errorData.description || 'API Error'}`, 'error');
                        return; // Non-retryable error, exit
                    }
                } catch (error) {
                    console.error("Fetch Error during Telegram send:", error);
                    // For network errors, retry with backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            showMessage("Konversi berhasil, tetapi gagal mengirim ke Telegram setelah beberapa kali coba (Timeout/Blocked).", 'error');
        }


        // --- Core Converter Logic ---

        function showMessage(message, type = 'error') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'border-red-400', 'border-green-400');

            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-800', 'border-red-400');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-800', 'border-green-400');
            }
        }

        // Function to copy a single URI (passed as base64 encoded string)
        function copySingleUri(b64Uri) {
            try {
                const uri = atob(b64Uri); 
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = uri;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                showMessage("URI berhasil disalin!", 'success');
            } catch (err) {
                showMessage("Gagal menyalin. Silakan coba lagi.", 'error');
                console.error('Copy single URI failed:', err);
            }
        }

        // Function to copy all URIs
        function copyAllUris(protocol) {
            const elementId = `allRawUris`;
            const textarea = document.getElementById(elementId);
            
            if (!textarea.value || textarea.value.trim() === '') {
                showMessage(`Tidak ada URI untuk disalin. Harap konversi terlebih dahulu.`, 'error');
                return;
            }
            
            try {
                textarea.select();
                textarea.setSelectionRange(0, 99999); 
                document.execCommand('copy');
                showMessage(`Semua URI berhasil disalin ke clipboard!`, 'success');
            } catch (err) {
                showMessage("Gagal menyalin semua URI. Silakan coba salin satu per satu.", 'error');
                console.error('Copy all URIs failed:', err);
            }
        }

        // Function to escape Markdown V2 special characters for Telegram text
        function escapeMarkdownV2(text) {
            if (!text) return '';
            // Escape characters: _, *, [, ], (, ), ~, `, >, #, +, -, =, |, {, }, ., !
            return text.replace(/([_*[\]()~`>#+\-=|{}.!])/g, '\\$1');
        }


        // Function to extract details and encode URI for a single outbound object
        function getV2rayUri(config, outbound, remarks, outboundTag = null) {
            const protocol = outbound.protocol;
            const settings = outbound.settings;
            const streamSettings = outbound.streamSettings;

            if (protocol !== 'vless' && protocol !== 'trojan') { return null; }

            let address, port, idOrPass, uriScheme;
            let params = {};
            let remarksText = remarks;

            if (outboundTag && outboundTag !== 'proxy') {
                remarksText = `${remarks} [${outboundTag}]`;
            }

            // --- 1. Extract Core Info (Address, Port, ID/Password) ---
            if (protocol === 'vless') {
                const vnext = settings?.vnext?.[0];
                if (!vnext) return null;
                address = vnext.address;
                port = vnext.port;
                idOrPass = vnext.users?.[0]?.id;
                uriScheme = 'vless';

                if (vnext.users?.[0]?.encryption !== 'none') {
                     params.encryption = vnext.users[0].encryption || 'none';
                }
            } else if (protocol === 'trojan') {
                const server = settings?.servers?.[0];
                if (!server) return null;
                address = server.address;
                port = server.port;
                idOrPass = server.password;
                uriScheme = 'trojan';
            } else { return null; }

            if (!address || !port || !idOrPass) {
                console.error(`Missing core info for ${protocol} config:`, config);
                return null;
            }

            // --- 2. Extract Stream Settings ---
            const network = streamSettings?.network || 'tcp';
            const security = streamSettings?.security || 'none';

            if (network) {
                params.type = network;
                
                if (network === 'ws') {
                    const wsSettings = streamSettings.wsSettings;
                    if (wsSettings?.host) params.host = wsSettings.host;
                    if (wsSettings?.path) params.path = wsSettings.path;
                }
            }

            // --- 3. Extract Security Settings (TLS/XTLS) ---
            if (security && security !== 'none') {
                params.security = security;

                if (security === 'tls' || security === 'xtls') {
                    const tlsSettings = streamSettings.tlsSettings;
                    if (tlsSettings) {
                        if (tlsSettings.serverName) params.sni = tlsSettings.serverName;
                        if (tlsSettings.fingerprint) params.fp = tlsSettings.fingerprint;
                        
                        if (tlsSettings.alpn && Array.isArray(tlsSettings.alpn) && tlsSettings.alpn.length > 0) {
                            params.alpn = tlsSettings.alpn.join(',');
                        }
                        
                        if (tlsSettings.allowInsecure === true) {
                            params.insecure = 1; 
                        }
                    }
                }
            }

            // --- 4. Collect Detailed Info for Formatted Output ---
            const details = {
                Remarks: remarksText,
                Protocol: uriScheme.toUpperCase(),
                Address: address,
                Port: port,
                Security: security.toUpperCase(),
                Network: network.toUpperCase(),
                Host: params.host || address,
                Path: params.path || '/',
                SNI: params.sni || 'N/A',
                Fingerprint: params.fp || 'N/A'
            };

            // --- 5. Build the URI String ---
            const encodedRemarks = encodeURIComponent(remarksText.trim());
            const paramString = Object.keys(params)
                .map(key => `${key}=${encodeURIComponent(params[key])}`)
                .join('&');

            const uri = `${uriScheme}://${idOrPass}@${address}:${port}?${paramString}#${encodedRemarks}`;
            
            return { uri, details, protocol };
        }

        // Function to create the neatly formatted HTML block
        function createFormattedBlock(index, uri, details) {
            // Function to safely escape HTML content for display
            const escape = (text) => String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            
            // Encode the URI for safe passing to the inline JS function
            const b64Uri = btoa(uri);
            
            // Determine styling based on protocol and security
            const isVless = details.Protocol === 'VLESS';
            const isSecure = details.Security === 'TLS' || details.Security === 'XTLS';
            
            const protocolIcon = isVless ? 'fa-bolt text-yellow-500' : 'fa-shield-alt text-indigo-500'; 
            const borderColor = isVless ? 'border-sky-400' : 'border-indigo-400';
            const securityBadgeBg = isSecure ? 'bg-green-500' : 'bg-red-500';
            const securityIcon = isSecure ? 'fa-lock' : 'fa-unlock';
            const networkIcon = details.Network === 'WS' ? 'fa-globe' : 'fa-network-wired';
            
            let html = `
                <div class="border-l-4 ${borderColor} border-gray-200 rounded-lg p-5 mb-4 shadow-xl bg-white transition duration-300 hover:shadow-2xl hover:border-r-2">
                    <h3 class="text-xl font-bold text-gray-900 mb-3 pb-3 border-b border-gray-100 flex items-center justify-between">
                        <span class="flex items-center">
                            <i class="fas ${protocolIcon} mr-3 text-2xl"></i>
                            <span class="font-extrabold text-lg">${details.Protocol}</span>
                            <span class="ml-3 text-base font-medium text-gray-600"> [${index}] ${escape(details.Remarks)}</span>
                        </span>
                        <span class="text-xs font-bold text-white px-3 py-1 rounded-full ${securityBadgeBg} shadow-md flex items-center">
                            <i class="fas ${securityIcon} mr-1"></i> ${details.Security}
                        </span>
                    </h3>
                    
                    <div class="text-sm text-gray-700 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 mb-4">
                        <p><strong class="text-gray-900 font-semibold"><i class="fas fa-server mr-2 text-blue-500"></i> Alamat:</strong> ${details.Address}:${details.Port}</p>
                        <p><strong class="text-gray-900 font-semibold"><i class="fas ${networkIcon} mr-2 text-purple-500"></i> Jaringan:</strong> ${details.Network}</p>
                        
                        ${details.Network === 'WS' ? `
                        <p><strong class="text-gray-900 font-semibold"><i class="fas fa-heading mr-2 text-gray-400"></i> Host Header:</strong> ${escape(details.Host)}</p>
                        <p><strong class="text-gray-900 font-semibold"><i class="fas fa-route mr-2 text-gray-400"></i> Path:</strong> ${escape(details.Path)}</p>
                        ` : ''}
                        
                        ${isSecure ? `
                        <p><strong class="text-gray-900 font-semibold"><i class="fas fa-fingerprint mr-2 text-green-500"></i> SNI:</strong> ${escape(details.SNI)}</p>
                        <p><strong class="text-gray-900 font-semibold"><i class="fas fa-id-card-alt mr-2 text-green-500"></i> Fingerprint:</strong> ${escape(details.Fingerprint)}</p>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0 md:space-x-4">
                        <div class="flex-1 min-w-0 w-full">
                            <p class="font-mono text-xs break-all bg-gray-100 p-3 rounded-xl border border-dashed border-gray-300 shadow-inner">
                                ${escape(uri)}
                            </p>
                        </div>
                        <button onclick="copySingleUri('${b64Uri}')"
                            class="w-full md:w-auto flex-shrink-0 bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white text-sm font-bold py-3 px-6 rounded-xl transition duration-150 shadow-lg hover:shadow-xl transform hover:scale-[1.03]">
                            <i class="fas fa-copy mr-2"></i> Salin URI (1 Akun)
                        </button>
                    </div>
                </div>
            `;
            return html;
        }

        // Function to create structured text output for Telegram
        function createTelegramBlock(index, uri, details) {
            const proto = details.Protocol;
            const sec = details.Security;
            const net = details.Network;
            
            let telegramText = `*${index}\\. ${escapeMarkdownV2(details.Remarks)}*\n`;
            telegramText += `\`${proto} | ${details.Address}:${details.Port} | ${sec} | ${net}\`\n`;

            if (net === 'WS') {
                telegramText += `\\- Host: \`${escapeMarkdownV2(details.Host)}\`\n`;
                if (details.Path !== '/') {
                    telegramText += `\\- Path: \`${escapeMarkdownV2(details.Path)}\`\n`;
                }
            }
            if (sec !== 'NONE' && details.SNI !== 'N/A') {
                telegramText += `\\- SNI: \`${escapeMarkdownV2(details.SNI)}\`\n`;
            }
            
            telegramText += `\n\`\`\`\n${escapeMarkdownV2(uri)}\n\`\`\`\n\n`;
            return telegramText;
        }


        // Main conversion function
        function convertJsonToV2ray() {
            const jsonInput = document.getElementById('jsonInput').value;
            const allContainer = document.getElementById('allOutputContainer');
            const allRaw = document.getElementById('allRawUris');
            const telegramOutput = document.getElementById('telegramOutput');

            allContainer.innerHTML = '';
            allRaw.value = '';
            telegramOutput.value = ''; // Clear telegram buffer
            document.getElementById('messageBox').classList.add('hidden');

            if (!jsonInput.trim()) {
                showMessage("Input JSON kosong. Harap masukkan konfigurasi V2Ray JSON.", 'error');
                allContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Input JSON kosong.</p>';
                return;
            }

            try {
                const configArray = JSON.parse(jsonInput);
                if (!Array.isArray(configArray)) {
                    showMessage("Input JSON harus berupa array (`[...]`).", 'error');
                    allContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Input JSON harus berupa array.</p>';
                    return;
                }

                let allHtml = '';
                let allRawList = [];
                let allTelegramText = '';
                let allCount = 0;

                configArray.forEach((config) => {
                    const remarks = config.remarks || 'Config Tanpa Nama';
                    const outbounds = config.outbounds || [];

                    // Filter relevant proxy outbounds
                    const proxyOutbounds = outbounds.filter(o => 
                        (o.protocol === 'vless' || o.protocol === 'trojan') && o.tag.startsWith('proxy')
                    );
                    
                    const results = [];
                    
                    if (proxyOutbounds.length > 1) {
                        // Handle multiple proxies (Best Ping / Balancer list)
                        proxyOutbounds.forEach(outbound => {
                            const result = getV2rayUri(config, outbound, remarks, outbound.tag);
                            if (result) results.push(result);
                        });
                    } else {
                        // Handle single 'proxy' tag (standard config)
                        const mainProxy = outbounds.find(o => o.tag === 'proxy');
                        if (mainProxy) {
                            const result = getV2rayUri(config, mainProxy, remarks);
                            if (result) results.push(result);
                        }
                    }

                    // Process results and append to the combined list
                    results.forEach((result) => {
                        const { uri, details } = result;
                        allCount++;
                        allHtml += createFormattedBlock(allCount, uri, details);
                        allRawList.push(uri);
                        allTelegramText += createTelegramBlock(allCount, uri, details);
                    });
                });

                // Update Containers and Raw URI list
                allContainer.innerHTML = allHtml || '<p class="text-center text-gray-500 p-8">Tidak ditemukan konfigurasi VLESS atau Trojan yang valid.</p>';
                allRaw.value = allRawList.join('\n');
                telegramOutput.value = allTelegramText;

                if (allCount > 0) {
                    // Telegram Send Logic
                    const token = localStorage.getItem(STORAGE_KEY_TOKEN);
                    const chatId = localStorage.getItem(STORAGE_KEY_CHAT_ID);
                    
                    if (token && chatId) {
                        // Send message and handle success/failure message inside sendToTelegram
                        sendToTelegram(`*-- Hasil Konversi V2Ray (${allCount} Akun) --*\n\n${allTelegramText}`);
                    } else {
                        showMessage(`Konversi berhasil! Ditemukan ${allCount} URI (VLESS & Trojan). Pengaturan bot tidak ditemukan/dinonaktifkan.`, 'success');
                    }
                } else {
                    showMessage("Tidak ditemukan konfigurasi VLESS atau Trojan yang valid di dalam JSON.", 'error');
                }

            } catch (e) {
                showMessage(`Error Parsing JSON: ${e.message}. Pastikan format JSON sudah benar.`, 'error');
                console.error("JSON Parsing Error:", e);
            }
        }
    </script>

</body>
</html>
